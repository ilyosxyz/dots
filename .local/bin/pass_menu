#!/bin/sh

# pass wrapper script

pass_type="xdotool type --delay 0 --clearmodifiers --file -"
tpl="/tmp/pass_last"

pass_select() {
  prefix="${PASSWORD_STORE_DIR:-$HOME/.password-store}/"
  find "$prefix" -name *.gpg | sed "s:$prefix::; s:.gpg::" | dmenu -i -p "Select:"
}

select_option() {
  printf "url\nusername\npassword\notp" | dmenu -i -p "Option:"
}

type_url() {
  urls="$(pass show "$1" 2>/dev/null | sed -n 's/^url://p;')"
  if [ "$(echo "$urls" | wc -l)" = 1 ]; then
    url="$urls"
  else
    url="$(echo "$urls" | dmenu -i -p "Select:")"
  fi
  echo "$url" | tr -d '\n' | $pass_type
}

type_username() {
  pass show "$1" 2>/dev/null | sed -n 's/^username://p;' | tr -d '\n' | $pass_type
}

type_password() {
  pass show "$1" 2>/dev/null | sed 1q | tr -d '\n' | $pass_type
}

type_otp() {
  pass otp code "$1" 2>/dev/null | tr -d '\n' | $pass_type
}

if [ "$1" = LAST ]; then
  p="$(cat $tpl 2>/dev/null || pass_select)"
else
  p="$(pass_select)"
fi

[ -n "$p" ] && echo "$p" > "$tpl" || exit 1

case "$(select_option)" in
  url)      type_url "$p";;
  username) type_username "$p";;
  password) type_password "$p";;
  otp)      type_otp "$p";;
esac
